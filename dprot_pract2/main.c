#include <stdio.h>
#include <string.h>
#include <openssl/md5.h>
#include <malloc.h>


char *join(char *s1, int size1, char *s2, int size2);
unsigned int gethexword32(const char *str);
void set_ctx(MD5_CTX *pctx, const char *digest, unsigned long nblocks);

int main() {
    unsigned char digest[] = {};
    unsigned char key[] = {0x71,0xa9,0x05,0x69,0xf5,0x17,0xbb,0x9f,0x48,0x3e,0x2f,0x31,0x58,0x11,0x05,0xb2};
    unsigned char mess1[] = {0x57,0x68,0x61,0x74,0x20,0x61,0x62,0x6f,0x75,0x74,0x20,0x6a,0x6f,0x69,0x6e,0x69,0x6e,0x67,0x20,0x6d,0x65,0x20,0x74,0x6f,0x6d,0x6f,0x72,0x72,0x6f,0x77,0x20,0x66,0x6f,0x72,0x20,0x64,0x69,0x6e,0x6e,0x65,0x72,0x3f};
    //char* key = "79a2571c8073b4b37233d8e9074061e9";
    //char* key = "79a2571c8073b4b37233d8e9074061e9";
    //char* mess1 = "What about joining me tomorrow for dinner?";
    int block_len = 32; // message blocks: 32B, hash size: 16B

    char *key_mess1 = join(key, 16, mess1, 42);
    int num_of_blocks = strlen(key_mess1)/block_len + 1;
    //unsigned char padding0[] = {0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
    //                            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x50};

    MD5_CTX context_digest;
    MD5_Init(&context_digest);
    //char *key_mess1_padding0 = join(key_mess1, strlen(key_mess1), padding0, 22);
    //MD5_Update(&context_digest, key_mess1_padding0, strlen(key_mess1)+22);
    //MD5_Update(&context_digest, padding0, 22);
    MD5_Update(&context_digest, key_mess1, 58);
    MD5_Final(digest, &context_digest);

    for(int i = 0; i < 16; ++i)
        printf("%02x", (unsigned int)digest[i]);
    printf("\n");

    unsigned char mess2[] = {0x4f,0x6f,0x70,0x73,0x2c,0x20,0x53,0x6f,0x72,0x72,0x79,0x2c,0x20,0x49,0x20,0x6a,0x75,0x73,0x74,0x20,0x72,0x65,0x6d,0x65,0x6d,0x62,0x65,0x72,0x20,0x74,0x68,0x61
            ,0x74,0x20,0x49,0x20,0x68,0x61,0x76,0x65,0x20,0x61,0x20,0x6d,0x65,0x65,0x74,0x69
            ,0x6e,0x67,0x20,0x76,0x65,0x72,0x79,0x20,0x73,0x6f,0x6f,0x6e,0x20,0x69,0x6e,0x20
            ,0x74,0x68,0x65,0x20,0x6d,0x6f,0x72,0x6e,0x69,0x6e,0x67,0x2e };
    unsigned char forgery_tag[16] = {};
    MD5_CTX context_forgery;
    MD5_Init(&context_forgery);
    set_ctx(&context_forgery, &digest, num_of_blocks);
    MD5_Update(&context_forgery, mess2, 76);
    MD5_Final(forgery_tag, &context_forgery);
    for(int i = 0; i < 16; ++i)
        printf("%02x", (unsigned int)forgery_tag[i]);
    printf("\n");



    unsigned char padding[] = {0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xd0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    //unsigned char padding[] = {0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x50, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    //unsigned char padding[] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
    //                           0x02, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    //unsigned char padding[] = {0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
    //                           0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x50};
    //unsigned char padding[] = {0x50, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80};
    //unsigned char padding[] = {0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    //unsigned char padding[] = {0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x50, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

    char *key_mess1_padding = join(key_mess1, 58, padding, 70);
    char *key_mess1_padding_mess2 = join(key_mess1_padding, 58 + 70, mess2, 76);
    unsigned char prove[16] = {};
    MD5_CTX context_prove;
    MD5_Init(&context_prove);
    MD5_Update(&context_prove, key_mess1_padding_mess2, 204);
    MD5_Final(prove, &context_prove);
    for(int i = 0; i < 16; ++i)
        printf("%02x", (unsigned int)prove[i]);
    printf("\n");

    return 0;
}

char *join(char *s1, int size1, char *s2, int size2) {
    char *result = malloc(size1 + size2 + 1);
    memcpy(result, s1, size1);
    memcpy(result+size1, s2, size2);
    return result;
}

// "12efc5ca" -> 0xcac5ef12
unsigned int gethexword32(const char *str) {
    return *(unsigned int *)str;
}

void set_ctx(MD5_CTX *pctx, const char *digest, unsigned long nblocks) {
    unsigned int *casted_ptr = (unsigned int *)digest;
    pctx->A = casted_ptr[0];
    pctx->B = casted_ptr[1];
    pctx->C = casted_ptr[2];
    pctx->D = casted_ptr[3];
    nblocks <<= 9; // converting into bits
    pctx->Nh = nblocks >> 32;
    //pctx->Nh = 592;
    pctx->Nl = nblocks & 0xFFFFFFFFul;
}

unsigned int md5Pad(unsigned char *message, size_t size) {
    uint64_t originalLength = size * 8;
    message[size++] = 0x80;
    while (size % 64 != 56)
        message[size++] = 0x00;
    memcpy(message + size, &originalLength, sizeof(uint64_t));
    return size + sizeof(uint64_t);
}